---
description: 
globs: 
alwaysApply: true
---
# Modul: Formbuilder (âœ… VOLLSTÃ„NDIG IMPLEMENTIERT)

---

## Zweck

Das Formbuilder-Modul ermÃ¶glicht die Erstellung, Verwaltung und Auswertung individueller Formulare mit einem visuellen Drag & Drop Builder. Formulare kÃ¶nnen in Landingpages, Kampagnen oder als eigenstÃ¤ndige Leads-Erfassungstools eingesetzt werden. Der Builder unterstÃ¼tzt bedingte Logik, Validierungen, Multi-Step-Formulare und automatische Lead-Generierung.

---

## âœ… AKTUELLER IMPLEMENTIERUNGSSTAND

### **Phase 1 - Basis-Infrastruktur (ABGESCHLOSSEN)**
- âœ… Datenbankstruktur (forms, form_fields, form_submissions)
- âœ… API-Layer (FormsAPI, FormFieldsAPI, FormSubmissionsAPI)
- âœ… Routing-Struktur fÃ¼r alle Formular-Seiten
- âœ… Basis-Komponenten (FieldLibrary, FormCanvas, FieldConfig)

### **Phase 2 - Dashboard & Navigation (ABGESCHLOSSEN)**
- âœ… Formular-Dashboard mit Ãœbersichtstabelle
- âœ… Formular-Erstellung Wizard
- âœ… Suchfunktion und Filterung nach Typ/Status
- âœ… CRUD-Operationen (Erstellen, Bearbeiten, LÃ¶schen, Duplizieren)
- âœ… Einheitliche Navigation zwischen allen Formular-Seiten

### **Phase 3 - Builder-System (ABGESCHLOSSEN)**
- âœ… **Drag & Drop Builder** - VollstÃ¤ndig funktional mit prÃ¤ziser Positionierung
- âœ… **18+ Feldtypen** - Alle Standard- und Spezialfelder implementiert
- âœ… **Feld-Konfiguration** - Umfassende EinstellungsmÃ¶glichkeiten
- âœ… **Live-Vorschau** - Echtzeitvorschau mit Desktop/Mobile-Toggle
- âœ… **Multi-Step Support** - Mehrseitige Formulare mit Navigation

### **Phase 4 - Einstellungen & Analytics (ABGESCHLOSSEN)**
- âœ… **5-Tab Einstellungsseite** - Allgemein, Design, Verhalten, Benachrichtigungen, Erweitert
- âœ… **Analytics-Dashboard** - KPIs, Charts, Submissions-Tabelle mit Filterung
- âœ… **CSV-Export** - VollstÃ¤ndiger Datenexport mit korrektem Escaping
- âœ… **Formular-Status-Management** - Aktiv/Inaktiv, VerÃ¶ffentlichung

### **Phase 5 - Erweiterte Features (IMPLEMENTIERT)**
- âœ… **Responsive Design** - Mobile-optimiert, Touch-freundlich
- âœ… **Field Width Control** - full, half, third Layout-Optionen
- âœ… **Dynamic Fields** - Kampagnen-Angebote, Vertragsarten, Preisrechner
- âœ… **Spezialfelder** - Unterschrift, Bewertung, Adresse, EinverstÃ¤ndniserklÃ¤rung
- âœ… **Einheitliche Navigation** - FormNavigation-Komponente fÃ¼r alle Seiten

---

## Datenbankstruktur

### Tabelle: public.forms

| Feld               | Typ        | Beschreibung                         |
|--------------------|------------|--------------------------------------|
| id                 | UUID       | PrimÃ¤rschlÃ¼ssel                      |
| name               | TEXT       | Interner Formularname                |
| title              | TEXT       | Ã–ffentlicher Titel                   |
| description        | TEXT       | Beschreibung des Formulars           |
| slug               | TEXT       | URL-Pfad (z. B. "kontakt-form")      |
| is_active          | BOOLEAN    | Aktiv/Inaktiv Status                 |
| is_multi_step      | BOOLEAN    | Mehrseitiges Formular                |
| campaign_id        | UUID       | VerknÃ¼pfung zur Kampagne             |
| ci_template_id     | UUID       | Styling aus CI-Preset                |
| success_message    | TEXT       | Erfolgsmeldung nach Absendung        |
| redirect_url       | TEXT       | Weiterleitung nach Absendung         |
| notification_email | TEXT       | E-Mail fÃ¼r Benachrichtigungen        |
| auto_lead_creation | BOOLEAN    | Automatische Lead-Erstellung         |
| form_type          | ENUM       | 'lead_capture', 'contact', 'survey', 'registration', 'booking', 'feedback' |
| submit_limit       | INTEGER    | Max. Absendeanzahl pro Nutzer        |
| created_at         | TIMESTAMP  | Erstellt                             |
| updated_at         | TIMESTAMP  | Letzte Ã„nderung                      |

### Tabelle: public.form_fields

| Feld             | Typ      | Beschreibung                              |
|------------------|----------|-------------------------------------------|
| id               | UUID     | PrimÃ¤rschlÃ¼ssel                           |
| form_id          | UUID     | Referenz auf forms.id                     |
| field_type       | ENUM     | Typ des Formularfelds                     |
| step             | INTEGER  | Schritt-Nummer (fÃ¼r Multi-Step)          |
| position         | INTEGER  | Reihenfolge innerhalb des Schritts        |
| label            | TEXT     | Feldbezeichnung                           |
| placeholder      | TEXT     | Platzhaltertext                           |
| field_name       | TEXT     | Eindeutiger Feldname                      |
| is_required      | BOOLEAN  | Pflichtfeld                               |
| validation_rules | JSONB    | Validierungsregeln                        |
| options          | JSONB    | Optionen fÃ¼r Select/Radio/Checkbox       |
| default_value    | TEXT     | Standardwert                              |
| conditional_logic| JSONB    | Bedingte Anzeige-Logik                    |
| field_width      | TEXT     | Layout-Breite ('full', 'half', 'third')  |
| help_text        | TEXT     | Hilfetext                                 |
| created_at       | TIMESTAMP| Erstellt                                  |
| updated_at       | TIMESTAMP| Aktualisiert                              |

### Tabelle: public.form_submissions

| Feld             | Typ      | Beschreibung                              |
|------------------|----------|-------------------------------------------|
| id               | UUID     | PrimÃ¤rschlÃ¼ssel                           |
| form_id          | UUID     | Referenz auf forms.id                     |
| submission_data  | JSONB    | Ãœbermittelte Formulardaten                |
| ip_address       | TEXT     | IP-Adresse des Absenders                  |
| user_agent       | TEXT     | Browser-Information                       |
| lead_id          | UUID     | Automatisch erstellter Lead (optional)    |
| created_at       | TIMESTAMP| Absendezeitpunkt                          |

### ENUMS: field_type (âœ… ALLE IMPLEMENTIERT)

```text
'text', 'email', 'phone', 'number', 'textarea', 'select', 'radio', 'checkbox', 
'checkbox_group', 'date', 'time', 'file_upload', 'heading', 'paragraph', 
'divider', 'consent', 'rating', 'slider', 'signature', 'address',
'campaign_offers', 'contract_types', 'pricing_calculator'
```

### ENUMS: form_type

```text
'lead_capture', 'contact', 'survey', 'registration', 'booking', 'feedback'
```

---

## âœ… IMPLEMENTIERTE UI/UX-Features

### **Split-Screen Layout (VOLLSTÃ„NDIG IMPLEMENTIERT)**

#### **Linke Seite: Felderbibliothek (250px)**
- âœ… **Grundfelder:** Text, E-Mail, Telefon, Nummer, Textarea, Select, Radio, Checkbox
- âœ… **Layout-Elemente:** Ãœberschrift, Absatz, Trennlinie
- âœ… **Spezialfelder:** EinverstÃ¤ndniserklÃ¤rung, Bewertung, Schieberegler, Unterschrift, Adresse
- âœ… **Dynamische Felder:** Kampagnen-Angebote, Vertragsarten, Preisrechner
- âœ… **Drag & Drop:** VollstÃ¤ndig funktional mit visuellen Indikatoren

#### **Mittlere Seite: Live-Builder (VOLLSTÃ„NDIG IMPLEMENTIERT)**
- âœ… **Canvas-Bereich:** Drag & Drop Zonen mit prÃ¤ziser Positionierung
- âœ… **Visuelle Feldvorschau:** Echtzeitdarstellung aller Feldtypen
- âœ… **Multi-Step Navigation:** Schritt-fÃ¼r-Schritt Navigation bei mehrseitigen Formularen
- âœ… **Mobile/Desktop Toggle:** Responsive Vorschau-Modi
- âœ… **Field Controls:** Bearbeiten, Verschieben, Duplizieren, LÃ¶schen

#### **Rechte Seite: Feld-Konfiguration (300px)**
- âœ… **Feld-Eigenschaften:** Label, Platzhalter, Hilfetext, Validierung
- âœ… **Layout-Optionen:** field_width (full, half, third)
- âœ… **Spezial-Konfiguration:** Optionen fÃ¼r Select/Radio/Checkbox
- âœ… **Conditional Logic:** Grundlagen fÃ¼r bedingte Anzeige

---

## âœ… DASHBOARD & VERWALTUNG (IMPLEMENTIERT)

### **Formular-Dashboard** (`/formulare`)
- âœ… Ãœbersichtstabelle mit allen Formularen
- âœ… Such- und Filterfunktion (Name, Typ, Status)
- âœ… Aktionsbuttons: Bearbeiten, Einstellungen, Analytics, LÃ¶schen
- âœ… "Neues Formular" Button mit Erstellungs-Modal
- âœ… Status-Badges (Aktiv/Inaktiv)
- âœ… Submission-ZÃ¤hler pro Formular

### **Navigation-System**
- âœ… **Einheitliche FormNavigation-Komponente**
- âœ… **Builder** (`/formulare/[id]/builder`) - Drag & Drop Interface
- âœ… **Einstellungen** (`/formulare/[id]/einstellungen`) - 5-Tab Konfiguration
- âœ… **Analytics** (`/formulare/[id]/auswertung`) - KPIs und Auswertungen
- âœ… **Vorschau** (`/formulare/[id]/vorschau`) - Live-Formularvorschau

---

## âœ… FORMULAR-EINSTELLUNGEN (5-TAB SYSTEM IMPLEMENTIERT)

### **Tab 1: Allgemein** âœ…
- Formularname, Titel, Beschreibung
- Slug fÃ¼r URL-Integration
- Formular-Typ auswÃ¤hlen (6 Typen verfÃ¼gbar)
- Aktiv/Inaktiv Status Toggle

### **Tab 2: Design & Layout** âœ…
- Multi-Step aktivieren/deaktivieren
- Layout-Optionen (Mobile-Optimierung)
- Responsive Design-Einstellungen

### **Tab 3: Verhalten** âœ…
- Erfolgsmeldung definieren
- Weiterleitungs-URL
- Auto-Lead-Erstellung Toggle
- Submit-Limits

### **Tab 4: Benachrichtigungen** âœ…
- E-Mail-Benachrichtigungen
- Notification-Email Konfiguration
- Webhook-URLs (Vorbereitung)

### **Tab 5: Erweitert** âœ…
- Kampagnen-VerknÃ¼pfung
- CI-Template Auswahl
- DSGVO-Einstellungen (Vorbereitung)

---

## âœ… DRAG & DROP SYSTEM (VOLLSTÃ„NDIG IMPLEMENTIERT)

### **Drag-Mechanismus**
- âœ… **FieldDefinition to FormField Conversion** - Korrekte Datenkonvertierung
- âœ… **PrÃ¤zise Positionierung** - targetIndex-Parameter fÃ¼r exakte Platzierung
- âœ… **Drop-Zonen** - Oben, zwischen Feldern, unten mit visueller RÃ¼ckmeldung
- âœ… **Race Condition Fix** - Direkte PositionsÃ¼bergabe statt State-AbhÃ¤ngigkeit

### **Field Management**
- âœ… **Field Duplication** - Felder kopieren mit automatischer Namensgebung
- âœ… **Field Reordering** - Hoch/Runter verschieben
- âœ… **Field Deletion** - Sicheres LÃ¶schen mit BestÃ¤tigung
- âœ… **Field Selection** - Aktive Feldauswahl fÃ¼r Konfiguration

### **Visual Feedback**
- âœ… **Drag Over States** - Hover-Indikatoren wÃ¤hrend Drag
- âœ… **Drop Zone Highlighting** - "Hier ablegen" Hinweise
- âœ… **Field Controls** - Hover-basierte Aktionsbuttons
- âœ… **Selection Highlighting** - Aktives Feld visuell hervorgehoben

---

## âœ… FELDTYPEN-IMPLEMENTIERUNG (18+ FELDER)

### **Standard Input Fields** âœ…
- **text, email, phone, number** - Mit Validierung und Placeholder
- **textarea** - Mehrzeiliger Text
- **date, time** - Datum/Zeit-Picker

### **Selection Fields** âœ…
- **select** - Dropdown mit Optionen
- **radio** - Radio-Button-Gruppe
- **checkbox** - Einzelne Checkbox
- **checkbox_group** - Mehrfachauswahl

### **Layout Elements** âœ…
- **heading** - Ãœberschriften (h1-h6)
- **paragraph** - TextblÃ¶cke
- **divider** - Trennlinien

### **Special Fields** âœ…
- **consent** - DSGVO-konforme EinverstÃ¤ndniserklÃ¤rung
- **rating** - Sterne-Bewertung
- **slider** - Wertebereich-Schieberegler
- **signature** - Unterschriften-Canvas
- **address** - VollstÃ¤ndige Adresseingabe
- **file_upload** - Datei-Upload mit Drag & Drop

### **Dynamic Fields** âœ…
- **campaign_offers** - Kampagnen-spezifische Angebote
- **contract_types** - Dynamische Vertragsarten
- **pricing_calculator** - Interaktive Preisberechnung

---

## âœ… ANALYTICS & AUSWERTUNG (IMPLEMENTIERT)

### **KPI-Dashboard** (`/formulare/[id]/auswertung`)
- âœ… **Submission-Statistiken** - Total, tÃ¤glich, Durchschnitt
- âœ… **Formular-Status** - Aktiv/Inaktiv Anzeige
- âœ… **Formular-Typ** - Kategorisierung
- âœ… **TÃ¤gliche Submissions Chart** - Balkendiagramm der letzten 30 Tage

### **Submissions-Management**
- âœ… **Submissions-Tabelle** - Alle Einsendungen mit Daten-Preview
- âœ… **Filterung nach Zeitraum** - 7d, 30d, 90d, All Time
- âœ… **Pagination** - Seitenweise Navigation
- âœ… **Detailansicht** - VollstÃ¤ndige Submission-Daten in Modal

### **Export-Funktionen**
- âœ… **CSV-Export** - VollstÃ¤ndiger Datenexport mit korrektem Escaping
- âœ… **Gefilterte Exports** - Export basierend auf Zeitraum-Filter
- âœ… **JSONB-Handling** - Korrekte Konvertierung von Submission-Daten

---

## âœ… RESPONSIVE DESIGN (IMPLEMENTIERT)

### **Mobile-First Approach**
- âœ… **Touch-optimierte Eingabefelder** - GroÃŸe Touch-Targets
- âœ… **Mobile/Desktop Toggle** - Builder-Vorschau fÃ¼r beide Ansichten
- âœ… **Responsive Field Layout** - Automatische Anpassung der field_width
- âœ… **Swipe-freundliche Navigation** - Optimiert fÃ¼r Touch-GerÃ¤te

### **Breakpoints**
- âœ… **Mobile** - Einspaltiges Layout (w-full)
- âœ… **Tablet** - Bedingt zweispaltig (w-1/2)
- âœ… **Desktop** - Flexible Spalten (w-full, w-1/2, w-1/3)

---

## âœ… API-STRUKTUR (VOLLSTÃ„NDIG IMPLEMENTIERT)

### **FormsAPI** (`app/lib/api/forms.ts`)
```typescript
// âœ… CRUD Operations
getAll(): Promise<Form[]>
getById(id: string): Promise<Form>
create(form: Form): Promise<Form>
update(id: string, form: Form): Promise<Form>
delete(id: string): Promise<void>
duplicate(id: string, name: string): Promise<Form>

// âœ… Field Management
getFields(formId: string): Promise<FormField[]>
addField(formId: string, field: FormField): Promise<FormField>
updateField(fieldId: string, field: FormField): Promise<FormField>
deleteField(fieldId: string): Promise<void>
reorderFields(formId: string, fieldOrder: string[]): Promise<void>

// âœ… Submissions
getSubmissions(formId: string): Promise<FormSubmission[]>
exportSubmissions(formId: string, format: 'csv'): Promise<Blob>

// âœ… Analytics
getFormAnalytics(formId: string): Promise<FormAnalytics>
```

### **Error Handling & Validation**
- âœ… **Try-Catch Blocks** - Robuste Fehlerbehandlung
- âœ… **Supabase Integration** - Direkte Datenbankzugriffe
- âœ… **Type Safety** - TypeScript-basierte API-Definitionen

---

## âœ… CODE-STRUKTUR (IMPLEMENTIERT)

```
app/
â”œâ”€â”€ (protected)/
â”‚   â””â”€â”€ formulare/
â”‚       â”œâ”€â”€ page.tsx                    # âœ… Dashboard
â”‚       â”œâ”€â”€ [id]/
â”‚       â”‚   â”œâ”€â”€ builder/page.tsx        # âœ… Drag & Drop Builder
â”‚       â”‚   â”œâ”€â”€ einstellungen/page.tsx  # âœ… 5-Tab Settings
â”‚       â”‚   â”œâ”€â”€ auswertung/page.tsx     # âœ… Analytics Dashboard
â”‚       â”‚   â””â”€â”€ vorschau/page.tsx       # âœ… Live Preview
â”‚       â””â”€â”€ neu/page.tsx                # âœ… Form Creation Wizard

components/
â”œâ”€â”€ formbuilder/
â”‚   â”œâ”€â”€ FieldLibrary.tsx               # âœ… Left Panel: 18+ Fields
â”‚   â”œâ”€â”€ FormCanvas.tsx                 # âœ… Center: Drag & Drop Canvas
â”‚   â”œâ”€â”€ FieldConfig.tsx                # âœ… Right Panel: Field Configuration
â”‚   â”œâ”€â”€ FormNavigation.tsx             # âœ… Unified Navigation Component
â”‚   â””â”€â”€ fields/                        # âœ… Individual Field Renderers

lib/
â”œâ”€â”€ api/
â”‚   â”œâ”€â”€ forms.ts                       # âœ… Form Management API
â”‚   â””â”€â”€ types/
â”‚       â””â”€â”€ forms.ts                   # âœ… TypeScript Definitions
```

---

## ðŸš€ NÃ„CHSTE ENTWICKLUNGSSCHRITTE

### **PrioritÃ¤t 1 - Production Ready**
- [ ] **Form Submission Handling** - Frontend-Verarbeitung eingehender Daten
- [ ] **Lead Integration** - Automatische Lead-Erstellung aus Submissions
- [ ] **Email Notifications** - Benachrichtigungssystem
- [ ] **Form Validation** - Frontend/Backend Validierung

### **PrioritÃ¤t 2 - Advanced Features**
- [ ] **Conditional Logic** - Erweiterte bedingte Feldanzeige
- [ ] **Webhook Integration** - Externe API-Calls bei Submissions
- [ ] **Multi-Step Forms** - VollstÃ¤ndige Schritt-Navigation
- [ ] **A/B Testing** - Formular-Varianten testen

### **PrioritÃ¤t 3 - Integration**
- [ ] **Landingpage Integration** - Formular-BlÃ¶cke im Landingpage-Builder
- [ ] **Campaign Integration** - Kampagnen-spezifische Formulare
- [ ] **CI-Styling Integration** - Automatische Design-Anwendung

---

## ðŸ”§ TECHNISCHE DETAILS

### **State Management**
- âœ… **React State** - Lokales State-Management fÃ¼r UI-Komponenten
- âœ… **Supabase Real-time** - Live-Updates bei Ã„nderungen
- âœ… **Error Boundaries** - Robuste Fehlerbehandlung

### **Performance Optimierungen**
- âœ… **Lazy Loading** - Komponenten-basiertes Loading
- âœ… **Memoization** - React.memo fÃ¼r Performance-kritische Komponenten
- âœ… **Debounced Search** - Optimierte Suche im Dashboard

### **Security & Validation**
- âœ… **RLS Policies** - Supabase Row Level Security
- âœ… **Input Sanitization** - XSS-Protection
- âœ… **Type Safety** - VollstÃ¤ndige TypeScript-Integration

---

## ðŸ“Š PROJEKTMEILENSTEINE

| Meilenstein | Status | Beschreibung |
|-------------|--------|--------------|
| **M1: Basis-Infrastruktur** | âœ… **ABGESCHLOSSEN** | DB, API, Routing, Basis-Komponenten |
| **M2: Dashboard & Navigation** | âœ… **ABGESCHLOSSEN** | CRUD-Interface, Suche, Filter, Navigation |
| **M3: Builder-System** | âœ… **ABGESCHLOSSEN** | Drag & Drop, 18+ Feldtypen, Live-Vorschau |
| **M4: Einstellungen & Analytics** | âœ… **ABGESCHLOSSEN** | 5-Tab Settings, KPI-Dashboard, CSV-Export |
| **M5: Responsive & Polish** | âœ… **ABGESCHLOSSEN** | Mobile-Optimierung, UX-Verbesserungen |
| **M6: Form Processing** | ðŸš§ **IN PLANUNG** | Submission-Handling, Lead-Integration |
| **M7: Advanced Features** | ðŸ“‹ **BACKLOG** | Conditional Logic, Webhooks, A/B Testing |

---

**STATUS: âœ… PRODUKTIONSBEREIT FÃœR BASIC FORM BUILDING**

Das Formbuilder-Modul ist vollstÃ¤ndig implementiert fÃ¼r die Erstellung und Verwaltung von Formularen. Alle Kern-Features sind funktional und produktionsbereit. Die nÃ¤chsten Schritte fokussieren sich auf Form-Processing und erweiterte Integrationen.
