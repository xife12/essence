---
description: 
globs: 
alwaysApply: true
---
# Modul: Mitglieder

## Tabelle: `public.members`

| Spalte        | Typ       | Beschreibung                                   |
|---------------|-----------|------------------------------------------------|
| id            | UUID      | Primärschlüssel                                |
| name          | TEXT      | Pflichtfeld (kombiniert aus firstname + lastname) |
| contact       | TEXT      | optional, z. B. E-Mail, Telefonnummer          |
| firstname     | TEXT      | optional                                       |
| lastname      | TEXT      | optional                                       |
| phone         | TEXT      | optional                                       |
| email         | TEXT      | optional                                       |
| birthdate     | DATE      | optional                                       |
| member_number | TEXT      | optional, z. B. aus Altbestand                 |
| created_at    | TIMESTAMP | automatisch                                    |
| updated_at    | TIMESTAMP | automatisch                                    |

---

## Übersicht

- Tabellenansicht mit:
  - Name
  - Kontakt (E-Mail oder Telefon)
  - Vertragsart + Restlaufzeit (farbiger Badge)
  - Status (abgeleitet: aktiv / gekündigt / geplant)
  - Aktion: "Details anzeigen"
- Floating Action Button: "+" Mitglied" → öffnet Modal zur Neuanlage
- **Anzeige geplanter Verträge**:
  - Wenn kein aktiver Vertrag, aber ein geplanter Vertrag existiert, wird dieser in der Übersicht angezeigt
  - Geplante Verträge sind visuell mit einem blauen Badge "Geplant (in X Tagen)" gekennzeichnet

---

## Detailansicht (Registerkarten)

- **Übersicht**:
  - Persönliche Daten
  - Aktueller Vertrag (inkl. Vertragsart, Laufzeit, Restlaufzeit)
  - **Kampagnenanzeige**: Falls ein Vertrag über eine Kampagne abgeschlossen wurde
  - **Status-Badges neben dem Namen**:
    - Vertragsstatus (aktiv, geplant, gekündigt, etc.)
    - Restlaufzeit mit Ampelsystem (grün, gelb, rot)
    - Mitgliedschaftszähler (wie oft der Kunde bereits verlängert hat)

- **Verträge**:
  - Tabelle aller Mitgliedschaften
  - **Kampagnenanzeige**: Jede Mitgliedschaft zeigt die zugehörige Kampagne (falls vorhanden)
  - Buttons:
    - "Vertrag verlängern"
    - "Vertrag kündigen"
    - "Vertrag stilllegen" (für aktive Verträge)
    - "Reaktivieren" (für stillgelegte Verträge)

- **Beratung** (optional):
  - Verknüpfte Beratungsgespräche
  - Zugriff auf Beratungsverlauf

- **Aktivität** (optional):
  - Chronologische Historie (Statuswechsel, Vertragsupdates, Kontaktänderungen)

---

## Restlaufzeit-Ampelsystem

- **Grün**: Mehr als 50% der Vertragslaufzeit verbleibend
- **Gelb**: Weniger als 50% der Laufzeit und mehr als 30 Tage bis zur Kündigungsfrist
- **Rot**: Innerhalb der Kündigungsfrist (30 Tage vor Vertragsende)
- Die verbleibenden Tage werden nummerisch angezeigt
- Info-Icon mit Tooltip erklärt die Bedeutung der Farben

---

## Mitgliedschaftszähler

- Badge neben dem Namen zeigt die Anzahl der früheren Mitgliedschaften
- **Blau**: Neukunde (erste Mitgliedschaft)
- **Lila**: Bestandskunde (mindestens eine Verlängerung)
- **Lila mit Zähler**: Langjähriger Kunde (mehrfache Verlängerungen)

---

## Erweitertes Kündigungsformular

- **Kündigungsarten**:
  - Fristgerechte Kündigung (reguläres Vertragsende)
  - Kündigung zu einem benutzerdefinierten Datum (individuelle Terminwahl)
  - Fristlose Kündigung (sofortige Beendigung)
- **Zusätzliche Felder**:
  - "Kündigung zum" (Datumseingabe für fristgerechte Kündigung)
  - Bei fristloser Kündigung wird das Enddatum auf das aktuelle Datum gesetzt
  - Bei benutzerdefinierter Kündigung wird ein Datumsfeld zur Auswahl des Kündigungstermins angezeigt

---

## Regeln

- Anlage auch mit rückwirkendem Datum möglich
- Hinweis im Modal:
  - "Mitgliedschaft muss separat hinterlegt werden"
- Verlängerung oder Kündigung erfolgt über Tab "Verträge"

---

## Rollenrechte

| Rolle         | Berechtigung                      |
|---------------|-----------------------------------|
| Mitarbeiter   | Mitglied einsehen & anlegen       |
| Studioleiter  | Vollzugriff                       |
| Admin         | Vollzugriff                       |

---

## Datenpersistenz

- **Lokale Datenspeicherung**:
  - Alle Änderungen an Mitgliedsdaten werden im `localStorage` persistiert
  - Jedes Mitglied wird unter einem eigenen Schlüssel `member_[id]` gespeichert
  - Beim Neuladen der Seite werden Daten automatisch aus dem localStorage geladen

## Vertragsstatus & Logik

- **Erweiterter Vertragsstatus**:
  - `active`: Laufender Vertrag (aktuell aktiv)
  - `planned`: Zukünftiger Vertrag (Startdatum in der Zukunft)
  - `cancelled`: Gekündigter Vertrag
  - `suspended`: Temporär stillgelegter Vertrag
  - `completed`: Abgelaufener Vertrag (automatische Erkennung)

- **Automatische Statusüberprüfung**:
  - Beim Laden werden `planned`-Verträge mit aktuellem/vergangenem Startdatum auf `active` gesetzt
  - Abgelaufene Verträge werden automatisch auf `completed` gesetzt

## Vertragsverlängerung

- **Intelligente Vertragsverlängerung**:
  - Der alte Vertrag bleibt `active` bis zum Start des neuen Vertrags
  - Enddatum des alten Vertrags wird automatisch auf den Tag vor dem Start des neuen Vertrags gesetzt
  - Der neue Vertrag erhält den Status `planned`, wenn sein Startdatum in der Zukunft liegt

- **Überlappungserkennung**:
  - Bei Überschneidungen von Vertragslaufzeiten wird eine Warnung angezeigt
  - Bestätigung der Überlappung passt das Enddatum des aktuellen Vertrags automatisch an

## Vertragsaktionen

- **Vertrag stilllegen**:
  - Temporäres Aussetzen eines Vertrags
  - Die Vertragslaufzeit wird automatisch um die Dauer der Stilllegung verlängert
  - Begründung und Stilllegungsdatum werden erfasst

- **Vertrag reaktivieren**:
  - Vorzeitige Reaktivierung passt die Restlaufzeit automatisch an
  - Das Enddatum wird basierend auf der tatsächlichen Stilllegungsdauer neu berechnet

## Daten-Synchronisierung

- **Bidirektionale Synchronisierung**:
  - Änderungen in der Detailansicht werden in der Übersicht reflektiert
  - Aktive Mitgliedschaften werden korrekt in der Mitgliederliste angezeigt
  - Status `planned` wird in der Übersicht mit blauem Badge dargestellt
