---
description: 
globs: 
alwaysApply: true
---
# Modul: Vertragsarten

## Zweck
Vertragsarten definieren die konfigurierbaren Konditionen und Optionen für Mitgliedschaften. Dazu zählen Laufzeit, Beiträge, optionale Module und Rabatte.

---

## Tabelle: `public.contract_types`

| Spalte              | Typ             | Beschreibung                                         |
|---------------------|------------------|------------------------------------------------------|
| id                  | UUID (PK)        | Eindeutiger Identifikator                            |
| name                | TEXT             | Vertragsbezeichnung                                 |
| description         | TEXT             | Freitext zur Erläuterung                            |
| term                | INTEGER          | Laufzeit in Monaten (manuell eingegeben)            |
| price_per_month     | DECIMAL(8,2)     | Monatlicher Beitrag                                 |
| bonus_period        | INTEGER          | Bonuszeitraum (Monate, optional)                    |
| auto_renew          | BOOLEAN          | Automatische Verlängerung                           |
| renewal_term        | INTEGER          | Verlängerungsdauer (wenn auto_renew = true)         |
| has_group_discount  | BOOLEAN          | Gruppenrabatt erlaubt?                              |
| group_discount_rate | DECIMAL(5,2)     | Rabatt in % (nur wenn has_group_discount = true)    |
| has_paid_modules    | BOOLEAN          | Kostenpflichtige Module erlaubt?                    |
| has_free_modules    | BOOLEAN          | Kostenfreie Module erlaubt?                         |
| active              | BOOLEAN          | Aktiv/inaktiv                                        |
| created_at          | TIMESTAMP        | Anlagezeitpunkt                                     |
| updated_at          | TIMESTAMP        | Änderungszeitpunkt                                  |

---

## Beziehung: `contract_type_modules`

| Spalte              | Typ              | Beschreibung                                  |
|---------------------|------------------|-----------------------------------------------|
| id                  | UUID (PK)        | Modul-ID                                      |
| contract_type_id    | FK → contract_types | Zugehörige Vertragsart                     |
| name                | TEXT             | Modulname                                     |
| is_paid             | BOOLEAN          | true = kostenpflichtig, false = kostenfrei    |
| price               | DECIMAL(8,2)     | Preis (nur bei kostenpflichtig)               |
| created_at          | TIMESTAMP        | Angelegt am                                   |

---

## UI-Komponenten

### Übersichtstabelle

| Spalte             | Beschreibung                          |
|--------------------|---------------------------------------|
| Name               | Vertragsbezeichnung                   |
| Laufzeit           | z. B. „12 Monate“                     |
| Beitrag            | Preis pro Monat                       |
| Gruppenrabatt      | Ja / Nein                             |
| Zubuchbare Module  | Ja / Nein                             |
| Kostenfreie Module | Ja / Nein                             |
| Bonuszeit          | optional, z. B. „+2 Monate“           |
| Aktiv              | Badge                                 |
| Aktion             | Bearbeiten / Deaktivieren             |

---

### Formular: Vertragsart anlegen/bearbeiten

Felder:

- Name (Pflicht)
- Beschreibung (optional)
- Laufzeit in Monaten (Zahleneingabe)
- Monatlicher Beitrag (€)
- Bonuszeitraum (optional)
- Automatische Verlängerung (Toggle)
  - Wenn aktiv → Verlängerungsdauer in Monaten
- Gruppenrabatt erlaubt? (Ja/Nein)
  - Wenn Ja: Eingabe Rabatt in Prozent (z. B. 10%)
- Zubuchbare Module erlaubt? (Ja/Nein)
  - Wenn Ja: Mehrfachauswahl mit Preis pro Modul
- Kostenfreie Module erlaubt? (Ja/Nein)
  - Wenn Ja: Mehrfachauswahl
- Aktiv (Checkbox)

---

## Vertragsmodule (eigener Bereich)

**Tabelle: `modules`**

| Spalte      | Typ             | Beschreibung                 |
|-------------|------------------|------------------------------|
| id          | UUID (PK)        | Modul-ID                     |
| name        | TEXT             | Modulname (z. B. „Sauna“)    |
| description | TEXT             | Erläuterung                  |
| created_at  | TIMESTAMP        | Anlagezeitpunkt              |

**Verwaltung:**  
- Zentrale Seite „Module“ → neue Module anlegen (Name, Beschreibung)
- Module können als „kostenfrei“ oder „kostenpflichtig“ mit Preis pro Vertrag zugewiesen werden
- Preis wird im Vertragstyp gespeichert

---

## Logik bei Mitgliedschaften

- Bei Auswahl eines Vertrags mit aktivem Gruppenrabatt:  
  → im Formular „Gruppenrabatt aktivieren“ (Ja/Nein)  
  → Rabatt in % wird automatisch auf `price_per_month` angewendet

- Zubuchbare Module → Checkbox + Preisberechnung in Mitgliedsvertrag
- Kostenfreie Module → als Text / Badge sichtbar

---

## Berechtigungen

| Rolle        | Berechtigung                            |
|--------------|------------------------------------------|
| Admin        | Vollzugriff                              |
| Studioleiter | Anlegen & Bearbeiten                     |
| Mitarbeiter  | keine Schreibrechte, nur Anzeige         |

---

## Hinweise für Cursor

- Formularlogik: bei aktivem Gruppenrabatt → Eingabefeld anzeigen
- Für Modulverknüpfung → relation table `contract_type_modules` verwenden
- Validierungen:
  - `term` > 0
  - `price_per_month` ≥ 0
  - Rabatt nur bei aktivierter Option
  - Nur aktive Vertragsarten bei Auswahl in `memberships`

