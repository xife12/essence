# ğŸ¯ VERTRAGSARTEN-SYSTEM V2 - RULE-STRUCTURE

## ğŸ“ ERSTELLT: VOLLSTÃ„NDIGE RULE-DOKUMENTATION

Das **Vertragsarten-System V2** wurde vollstÃ¤ndig dokumentiert mit folgenden Rule-Dateien:

### **ğŸ“‹ 1. MASTERPLAN & ÃœBERSICHT**
- âœ… **`vertragsarten-v2-plan.mdc`** - Detaillierter Implementierungsplan (16-21 Tage)
- âœ… **`vertragsarten-v2-overview.mdc`** - SystemÃ¼bersicht mit 3 Hauptbereichen

### **ğŸ—„ï¸ 2. DATENBANKSTRUKTUR**
- âœ… **`vertragsarten-v2-database.mdc`** - Komplettes Schema mit 11 Tabellen
  - `contracts` (Haupt-VertrÃ¤ge mit Versionierung)
  - `contract_terms`, `contract_pricing`, `contract_starter_packages`, `contract_flat_rates`
  - `contract_modules`, `module_categories`, `contract_module_assignments`
  - `contract_documents`, `contract_document_sections`, `contract_document_assignments`

### **ğŸ”„ 3. VERSIONIERUNGS-SYSTEM**
- âœ… **`vertragsarten-v2-versioning.mdc`** - Komplette Versionierungs-Logik
  - Automatische Versionierung bei Ã„nderungen
  - KampagnenvertrÃ¤ge mit zeitgesteuerter Aktivierung
  - Historien-Tracking und Ã„nderungsnotizen
  - Parallele Versionen ohne Datenverlust

### **ğŸ§© 4. MODUL-SYSTEM**
- âœ… **`vertragsarten-v2-modules.mdc`** - Kategorisierte Module mit Icons
  - 9 Standard-Kategorien (Training, Wellness, Premium, etc.)
  - Icon-Picker mit Lucide + Custom Upload
  - Schnellzuordnung (Bulk-Assignment zu VertrÃ¤gen)
  - PreisÃ¼berschreibung pro Vertrag

### **ğŸ“„ 5. VERTRAGSDOKUMENTE**
- âœ… **`vertragsarten-v2-documents.mdc`** - WYSIWYG-Editor + PDF-Generation
  - TinyMCE-Integration mit Custom-Buttons
  - Variable-System fÃ¼r dynamische Inhalte
  - Split-Screen Live-Vorschau
  - Puppeteer-basierte PDF-Generation

---

## ğŸ”¥ **SYSTEM-TRANSFORMATION: ALT â†’ NEU**

### **VORHER (V1):**
```
contract_types (einfache Tabelle)
â”œâ”€â”€ Statische Felder
â”œâ”€â”€ Basis-Module Ã¼ber contract_type_modules
â””â”€â”€ Keine Versionierung
```

### **NACHHER (V2):**
```
VERTRÃ„GE (mit Versionierung + Kampagnen)
â”œâ”€â”€ Automatische Versionierung
â”œâ”€â”€ KampagnenvertrÃ¤ge mit Zeitsteuerung
â”œâ”€â”€ Preisdynamik (Stichtag, wiederholend)
â”œâ”€â”€ Startpakete & Pauschalen
â””â”€â”€ Erweiterte Rabattlogik

MODULE (kategorisiert + Icons)
â”œâ”€â”€ 9 Standard-Kategorien
â”œâ”€â”€ Icon-System (Lucide + Custom)
â”œâ”€â”€ Schnellzuordnung (Bulk-Assignment)
â””â”€â”€ PreisÃ¼berschreibung pro Vertrag

VERTRAGSDOKUMENTE (WYSIWYG + PDF)
â”œâ”€â”€ Vollbild-Editor mit Live-Vorschau
â”œâ”€â”€ Modulare Abschnitte
â”œâ”€â”€ Variable-System (Stammdaten, etc.)
â””â”€â”€ PDF-Generation mit Puppeteer
```

---

## âš¡ **IMPLEMENTIERUNGS-ROADMAP**

### **ğŸ”´ PHASE 1: INFRASTRUKTUR (3-4 Tage)**
```bash
# Datenbankstruktur
1. Migration: create_contracts_v2_schema.sql
2. Migration: migrate_contract_types_to_v2.sql  
3. Migration: create_rls_policies.sql
4. API-Layer: ContractsV2API, ModulesV2API, DocumentsAPI
```

### **ğŸŸ¡ PHASE 2: BUSINESS LOGIC (4-5 Tage)**
```bash
# Versionierungs-System
1. Auto-Versionierung bei Ã„nderungen
2. Kampagnenlogik (zeitgesteuerte Aktivierung)
3. Preisdynamik-Engine (Stichtag, wiederholend)
4. Ã„nderungsnotizen (automatisch + manuell)
```

### **ğŸŸ¢ PHASE 3: USER INTERFACE (5-6 Tage)**
```bash
# 3 Hauptbereiche
1. VertrÃ¤ge-Bereich (Ãœbersicht + Versionierung)
2. Module-Bereich (Kategorien + Schnellzuordnung)
3. Dokumente-Bereich (WYSIWYG + PDF-Vorschau)
4. Navigation zwischen Bereichen
```

### **ğŸ”µ PHASE 4: INTEGRATION (2-3 Tage)**
```bash
# Bestehende Module anpassen
1. Mitgliedschaften: Neue Vertragsauswahl
2. Kampagnen: Kampagnenvertrag-Erstellung
3. Beratung/Leads: Aktualisierte Formulare
4. Dateimanager: Icon-Integration
```

### **âš« PHASE 5: TESTING & ROLLOUT (2-3 Tage)**
```bash
# Validierung & Go-Live
1. DatenintegritÃ¤t prÃ¼fen
2. Performance-Tests
3. Mitarbeiter-Schulung
4. Schrittweiser Rollout
```

---

## ğŸ¯ **USERFLOWS: DIE 3 HAUPTSTRÃ„NGE**

### **ğŸ”¸ STRANG A: VERTRÃ„GE**
```
Ãœbersicht â†’ + Neuer Vertrag â†’ Konfiguration â†’ Speichern
    â†“
Auto-Versionierung: v2.0 erstellt, v1.0 bleibt fÃ¼r Bestand aktiv
    â†“
Ã„nderungsnotiz: "AUTO: Preise angepasst" + manuelle ErgÃ¤nzung
```

### **ğŸ”¸ STRANG B: MODULE**
```
Kategorien-Filter â†’ + Modul hinzufÃ¼gen â†’ Icon & Kategorie wÃ¤hlen
    â†“
Schnellzuordnung: Matrix-View â†’ Bulk-Assignment â†’ Auto-Update aller VertrÃ¤ge
```

### **ğŸ”¸ STRANG C: VERTRAGSDOKUMENTE**
```
Dokument-Ãœbersicht â†’ + Neues Dokument â†’ Vollbild-Editor (Split-Screen)
    â†“
Abschnitte: + hinzufÃ¼gen â†’ WYSIWYG â†’ Live-PDF-Vorschau
    â†“
VerknÃ¼pfung: Mehreren VertrÃ¤gen zuordnen â†’ Speichern
```

### **ğŸ”¸ STRANG A1: KAMPAGNENVERTRÃ„GE**
```
Basis-Vertrag â†’ "Kampagnenvertrag erstellen" â†’ Anpassungen
    â†“
Zeitraum: Start/Ende-Datum â†’ Auto-Aktivierung wÃ¤hrend Kampagne
    â†“
Nach Kampagne: Auto-RÃ¼ckschaltung zu Original-Vertrag
```

---

## ğŸ”— **INTEGRATION MIT BESTEHENDEN MODULEN**

### **Mitgliedschaften (@mitgliedschaften)**
- Vertragsauswahl zeigt aktive Versionen + KampagnenvertrÃ¤ge
- Preisdynamik wird in Beitragsberechnung integriert
- Startpaket-Integration bei Vertragsabschluss

### **Kampagnen (@kampagnen)**
- Kampagnenvertrag-Erstellung aus Basis-Vertrag
- Zeitgesteuerte Aktivierung/Deaktivierung
- VerlÃ¤ngerungslogik mit automatischer Versionierung

### **Beratung (@beratung) & Leads**
- Aktualisierte Vertragsauswahl in Formularen
- KampagnenvertrÃ¤ge in BeratungsgesprÃ¤chen
- Preisvorschau mit dynamischen Berechnungen

### **Dateimanager (@dateimanager)**
- Modul-Icons aus Asset-Verwaltung
- Vertragsdokument-Assets (Logos, Header)
- PDF-Template-Verwaltung

---

## ğŸ“Š **TECHNISCHE ANFORDERUNGEN**

### **Dependencies**
```json
{
  "@tinymce/tinymce-react": "^4.3.0",
  "puppeteer": "^21.0.0", 
  "html-pdf": "^3.0.1",
  "react-pdf": "^7.3.0"
}
```

### **Datenbankviews fÃ¼r RÃ¼ckwÃ¤rtskompatibilitÃ¤t**
```sql
CREATE VIEW contract_types AS 
SELECT ... FROM contracts WHERE is_active = true;
```

### **Performance-Optimierungen**
- Indizes fÃ¼r hÃ¤ufige Abfragen
- Stored Procedures fÃ¼r Bulk-Operations
- Volltext-Suche fÃ¼r VertrÃ¤ge und Module

---

## âœ… **ERFOLGSKRITERIEN**

### **Funktional**
- âœ… Alle bestehenden VertrÃ¤ge migriert ohne Datenverlust
- âœ… Versionierung funktioniert zuverlÃ¤ssig
- âœ… Kampagnenlogik arbeitet korrekt
- âœ… PDF-Generation unter 5 Sekunden

### **Performance**
- âœ… Seitenlade-Zeiten < 2 Sekunden
- âœ… Bulk-Operations unter 10 Sekunden
- âœ… Concurrent User > 50 ohne Performance-Verlust

### **User Experience**
- âœ… Intuitive Navigation zwischen 3 Bereichen
- âœ… Fehlerrate < 5% bei Vertragsenerstellung
- âœ… Positive Feedback von Mitarbeitern
- âœ… WYSIWYG-Editor funktioniert reibungslos

---

## ğŸš€ **READY FOR IMPLEMENTATION**

**Status:** âœ… **VollstÃ¤ndig dokumentiert und planungsbereit**

**Alle Rules erstellt:**
- Masterplan (16-21 Tage Roadmap)
- Datenbankschema (11 Tabellen)
- Versionierungs-System (automatisch + Kampagnen)
- Modul-System (Kategorien + Icons)
- Dokumente-System (WYSIWYG + PDF)

**NÃ¤chster Schritt:** Migration Phase 1 starten - Datenbankstruktur implementieren

---

## ğŸ“ **NOTIZEN FÃœR CURSOR**

Diese Rule-Struktur ersetzt das alte Vertragsarten-System vollstÃ¤ndig. 
Alle Dateien sind miteinander verknÃ¼pft und bilden ein konsistentes System.

**Bei Implementierung beachten:**
- RÃ¼ckwÃ¤rtskompatibilitÃ¤t durch Views gewÃ¤hrleisten
- Bestehende Mitgliedschaften nicht beschÃ¤digen  
- Schrittweise Migration mit Rollback-Option
- Performance-Monitoring wÃ¤hrend Rollout