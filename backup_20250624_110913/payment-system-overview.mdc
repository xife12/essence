---
description:
globs:
alwaysApply: false
---
# Modul: Payment-System (âœ… BETA-VERSION FÃœR 24.06.2025)

## ğŸ¯ Zweck
Das Payment-System-Modul ermÃ¶glicht den vollstÃ¤ndigen Import von Mitgliedsdaten aus Magicline-PDFs und die DurchfÃ¼hrung von SEPA-ZahllÃ¤ufen. Es bildet die KernfunktionalitÃ¤t fÃ¼r Fitnessstudio-Mitgliederverwaltung und Zahlungsabwicklung.

---

## ğŸ“Š MODUL-KOMPONENTEN

### **ğŸ”¸ A) MITGLIEDER-UPLOAD-SYSTEM**
- **PDF-Upload**: Vertrag + Kontoauszug simultaner Upload
- **Automatische Extraktion**: Name, Mitgliedsnummer, IBAN, Kontostand, Vertragsarten
- **Validierungs-Checkliste**: âœ…/âŒ fÃ¼r alle extrahierten Felder
- **Fallback-UI**: Manuelle Nachbearbeitung bei fehlgeschlagener Extraktion
- **7-Schritte-Workflow**: Upload â†’ Extraktion â†’ Validation â†’ Nachbearbeitung â†’ Contract-Matching â†’ Mitglied-Erstellung â†’ Zahllaufgruppen-Zuordnung

### **ğŸ”¸ B) SEPA-ZAHLUNGSLÃ„UFE**
- **Zahllauf-Engine**: Automatische Forderungssammlung nach Zahllaufgruppen
- **SEPA-XML-Export**: pain.008.003.02 konforme Dateien fÃ¼r Banken
- **Status-Tracking**: Draft â†’ Ready â†’ Submitted â†’ Processed
- **RÃ¼cklastschrift-Management**: GebÃ¼hrenberechnung und Status-Updates

### **ğŸ”¸ C) BEITRAGSKONTO-SYSTEM**
- **Member-Accounts**: Individuelle KontofÃ¼hrung pro Mitglied
- **Historische Rekonstruktion**: Zahlungshistorie aus PDF-KontoauszÃ¼gen
- **Automatische Buchungslogik**: Anteilige BeitrÃ¤ge, Ruhezeiten, Ãœberzahlungen
- **Forderungsmanagement**: Positive/negative KontostÃ¤nde korrekt verwaltet

### **ğŸ”¸ D) STUDIO-KONFIGURATION**
- **Systemeinstellungen**: Studio-Stammdaten, SEPA-Konfiguration
- **Zahllaufgruppen**: "01. des Monats", "15. des Monats" individuell erstellbar
- **Forderungstypen**: Standardisierte Zuordnung (Beitrag, Startpaket, Pauschale)
- **GlÃ¤ubiger-ID-Management**: Studio-spezifische SEPA-Einstellungen

---

## ğŸ—„ï¸ DATENBANKSTRUKTUR

### **Haupttabellen:**
- `members` - Mitglieder-Stammdaten mit PDF-extrahierten Informationen
- `member_accounts` - Beitragskonten mit Salden und Historien
- `member_transactions` - Detaillierte Buchungshistorie aus PDFs
- `payment_runs` - SEPA-ZahllÃ¤ufe mit XML-Export-Tracking
- `payment_groups` - Zahllaufgruppen-Konfiguration
- `studio_settings` - Studio-Konfiguration fÃ¼r SEPA und Stammdaten

### **PDF-Extraktion-Felder:**
```typescript
interface ExtractedMemberData {
  memberNumber: string;        // Kritisch: Duplikat-Check
  fullName: string;
  firstName: string;
  lastName: string;
  birthDate: string;
  address: {
    street: string;
    houseNumber: string;
    zipCode: string;
    city: string;
  };
  bankData: {
    iban: string;
    bic: string;
    mandateRef: string;
    creditorId: string;
  };
  contractData: {
    tariffName: string;         // FÃ¼r Vertragsarten-Matching
    monthlyAmount: number;
    contractStart: string;
  };
  accountBalance: number;       // Positiv = Ãœberzahlung, Negativ = Forderung
  transactions: Transaction[];  // Historische Zahlungsdaten
}
```

---

## ğŸ¨ UI/UX-WORKFLOWS

### **ğŸ“¤ Mitglieder-Upload-Flow (7 Schritte):**
1. **PDF-Upload**: Drag & Drop fÃ¼r Vertrag + Kontoauszug
2. **Automatische Extraktion**: Live-Progress mit Pattern-Matching
3. **Validierungs-Checkliste**: âœ…/âŒ Status fÃ¼r alle Felder
4. **Manuelle Nachbearbeitung**: Formular fÃ¼r fehlgeschlagene Extraktion
5. **Vertragsarten-Matching**: Automatisch oder manuelle Auswahl
6. **Mitglied-Erstellung**: Automatische Anlage mit Beitragskonto
7. **Zahllaufgruppen-Zuordnung**: Dropdown-Auswahl fÃ¼r SEPA-Termine

### **ğŸ’° Finanzen-Dashboard:**
- **ZahllÃ¤ufe-Ãœbersicht**: Alle durchgefÃ¼hrten und geplanten LÃ¤ufe
- **SEPA-Export**: XML-Download fÃ¼r Bank-Einreichung
- **RÃ¼cklastschrift-Management**: GebÃ¼hren und Status-Updates
- **ForderungsÃ¼bersicht**: Offene BetrÃ¤ge und Ãœberzahlungen

### **ğŸ“‹ Mitglieder-Dokumentenverwaltung:**
- **"Dokumente"-Tab**: Automatisch auf jeder Mitglieder-Detailseite
- **PDF-Organisation**: Upload-PDFs automatisch nach Mitglied sortiert
- **Einzelne Uploads**: ZusÃ¤tzliche Dateien auf Mitgliederebene
- **Integration Dateimanager**: Bestehende Storage-API nutzen

---

## ğŸ”— MODUL-INTEGRATIONEN

### **Mit Vertragsarten-V2:**
- **Automatisches Matching**: Tarif-Name + Preis-Validation
- **Fallback-UI**: Bei mehreren/keinen Matches manuelle Auswahl
- **Konsistenz-PrÃ¼fung**: Preisabgleich zwischen PDF und System

### **Mit Dateimanager:**
- **PDF-Storage**: `/members/{memberId}/documents/` Struktur
- **Berechtigungen**: Admin fÃ¼r Upload, Studioleiter fÃ¼r Einzeldateien
- **Integration**: Bestehende Upload-API erweitern

### **Mit Mitarbeiterverwaltung:**
- **Rollen-Kontrolle**: Nur Admins fÃ¼r ZahllÃ¤ufe
- **Audit-Logs**: Alle kritischen Aktionen protokolliert
- **Berechtigungen**: Studioleiter fÃ¼r Mitglieder-Verwaltung

---

## ğŸ“Š BETA-ERFOLGSKENNZAHLEN

### **PDF-Extraktion:**
- **Erfolgsrate**: 95%+ automatische Extraktion
- **Mitgliedsnummer**: 100% kritisch (Duplikat-Check)
- **IBAN-Validation**: Live-PrÃ¼fung via API
- **Kontostand**: Korrekte +/- Interpretation

### **SEPA-Integration:**
- **XML-Format**: pain.008.003.02 konforme Ausgabe
- **Bank-KompatibilitÃ¤t**: Erfolgreich bei Sparkasse/Volksbank getestet
- **Sandbox-Modus**: Sichere Beta-Tests ohne echte Abbuchungen

### **Vertragsarten-Matching:**
- **Automatik-Rate**: 90%+ erfolgreiche Auto-Zuordnung
- **Preis-Toleranz**: Â±1,00â‚¬ fÃ¼r flexible Matching
- **Fallback-Rate**: <10% manuelle Nachbearbeitung

---

## ğŸš¨ KRITISCHE IMPLEMENTATION-PUNKTE

### **DatenqualitÃ¤t:**
- **Mitgliedsnummer-Eindeutigkeit**: Absolut kritisch fÃ¼r System-IntegritÃ¤t
- **IBAN-Validation**: Live-PrÃ¼fung vor SEPA-Export erforderlich
- **Kontostand-Interpretation**: Ãœberzahlung vs. Forderung korrekt unterscheiden

### **SEPA-Compliance:**
- **GlÃ¤ubiger-ID**: Studio-spezifisch, nicht zentral
- **Mandatsreferenz**: Aus PDF extrahiert und validiert
- **Sammellastschrift**: Nur bei identischen Zahllaufgruppen

### **Error-Handling:**
- **PDF-Parsing-Fehler**: Graceful Degradation mit Fallback-UI
- **Duplicate-Detection**: Robuste Mitgliedsnummer-PrÃ¼fung
- **SEPA-Validation**: Umfassende Pre-Export-Checks

---

## ğŸ¯ BETA-TIMELINE (19.-23.06.2025)

### **Tag 1-2: Foundation**
- Datenbank-Schema via MCP Supabase
- PDF-Processing-Engine mit node-sepa
- Basis-APIs fÃ¼r alle Entities

### **Tag 3-4: Core Features**
- Mitglieder-Upload-Interface
- SEPA-XML-Export-Engine
- Finanzen-Dashboard-GrundgerÃ¼st

### **Tag 5: Beta-Vorbereitung**
- End-to-End-Tests
- Test-Daten-Import
- Production-Deployment

---

## ğŸ“‹ NEXT STEPS FÃœR DEVELOPMENT

### **Immediate (Heute):**
1. **MCP Supabase**: Neue Tabellen-Schema erstellen
2. **Dependencies**: pdf-parse, node-sepa, iban-validator installieren
3. **API-Foundation**: Basis-Endpunkte fÃ¼r Members/PaymentRuns

### **This Week:**
4. **PDF-Processing**: Extraktion-Engine mit Pattern-Matching
5. **UI-Components**: Upload-Interface + Validation-Checkliste
6. **SEPA-Engine**: XML-Generation + Bank-Integration

### **Beta-Ready:**
7. **Integration-Tests**: Mit echten Magicline-PDFs
8. **Performance-Optimization**: FÃ¼r Bulk-Upload-Scenarios
9. **Error-Handling**: Robuste Fallback-Mechanismen

---

*Letzte Aktualisierung: 23.06.2025*
*Status: ğŸš€ Implementation-Ready fÃ¼r 5-Tage-Sprint*
